{
  "name": "Agente Carolina v3 - DSL",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "carolina-v3-process",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "11ae8c6b-04cb-401e-a190-0cead64c84a1",
      "name": "Webhook Trigger (from Historial)",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        1712,
        2752
      ],
      "webhookId": "carolina-v3-process"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ { \"success\": true, \"message\": \"Processing\" } }}",
        "options": {}
      },
      "id": "ae8dc537-e8c5-4592-9751-4bf292a11f04",
      "name": "Respond Immediately",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [
        1920,
        2752
      ]
    },
    {
      "parameters": {
        "jsCode": "const phone = $json.body?.phone || $json.phone || '';\n\nif (!phone) {\n  throw new Error('Phone parameter required');\n}\n\nreturn { phone };"
      },
      "id": "f2d633f9-574e-47ad-b68f-ce428df1a6b1",
      "name": "Parse Trigger",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2144,
        2752
      ]
    },
    {
      "parameters": {
        "url": "=https://n8n.automatizacionesmorf.com/webhook/historial-v3-snapshot?phone={{ $json.phone }}",
        "options": {}
      },
      "id": "856172f8-4890-44bb-8654-f74dc16dc377",
      "name": "Get Snapshot",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        2368,
        2752
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 1
          },
          "conditions": [
            {
              "id": "2f29b608-4bbc-4324-8db4-4a40d8f9d3c9",
              "leftValue": "={{ $json.pending_count }}",
              "rightValue": 0,
              "operator": {
                "type": "number",
                "operation": "gt"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "df0ec143-4363-44b7-8b9e-6ebf6cb0832f",
      "name": "Check Pending > 0",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        2592,
        2752
      ]
    },
    {
      "parameters": {
        "jsCode": "// CAROLINA V3 - Extrae intent del state (sin Claude)\nconst snapshot = $json;\nconst state = snapshot.state || {};\nconst messages = snapshot.messages || [];\n\n// Leer intent del state (ya detectado por State Analyzer)\nconst intent = state._last_intent || 'fallback';\nconst intentsVistos = state._intents_vistos || [];\nconst packDetectado = state.pack || null;\nconst camposCompletos = state._campos_completos || false;\n\n// Detectar quÃ© templates ya se enviaron\nconst botMessages = messages.filter(m => m.role === 'assistant');\nconst templatesSent = botMessages.map(m => ({\n  content: m.content,\n  preview: m.content.substring(0, 100)\n}));\n\nconsole.log('ðŸ“Š INTENT FROM STATE:', {\n  intent,\n  intentsVistos,\n  packDetectado,\n  camposCompletos,\n  templatesAlreadySent: templatesSent.length\n});\n\nreturn {\n  intent,\n  intents_vistos: intentsVistos,\n  pack_detectado: packDetectado,\n  campos_completos: camposCompletos,\n  captured_data: state,\n  templates_sent: templatesSent,\n  phone: snapshot.phone,\n  session_id: snapshot.session_id,\n  contact_id: snapshot.contact_id || '',\n  snapshot_version: snapshot.version\n};"
      },
      "id": "c7a08312-d418-4f06-a42f-dc10c112e914",
      "name": "Extract Intent from State",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3216,
        2656
      ]
    },
    {
      "parameters": {
        "jsCode": "// Check if bot is disabled by tags\nconst snapshot = $json;\nconst tags = snapshot.tags || [];\n\nconst blockedTags = ['WPP', 'P/W', 'bot_off', 'RECO'];\nconst hasBlockedTag = tags.some(tag => blockedTags.includes(tag));\n\nconsole.log('ðŸ·ï¸ CHECKING TAGS:', {\n  tags,\n  hasBlockedTag,\n  phone: snapshot.phone\n});\n\nreturn {\n  ...snapshot,\n  has_blocked_tag: hasBlockedTag\n};"
      },
      "id": "1ae686da-f7cf-4b02-bce7-c57ef01122e6",
      "name": "Check Tags (Bot Bloqueado?)",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2816,
        2672
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "tag-bloqueado-check",
              "leftValue": "={{ $json.has_blocked_tag }}",
              "rightValue": false,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "0183c9d2-171d-4245-871c-fc884145f7c2",
      "name": "IF: Tags Allow Bot?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        2992,
        2672
      ]
    },
    {
      "parameters": {
        "jsCode": "// Log: Bot disabled by tags\nconst snapshot = $json;\n\nconsole.log('ðŸš« BOT DISABLED BY TAGS:', {\n  phone: snapshot.phone,\n  tags: snapshot.tags,\n  reason: 'Bot bloqueado por tags'\n});\n\nreturn {\n  skipped: true,\n  reason: 'bot_disabled_by_tags',\n  phone: snapshot.phone,\n  tags: snapshot.tags\n};"
      },
      "id": "ce6b1e50-08da-4d48-aadc-25bc9a80a425",
      "name": "Log Bot Disabled",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3232,
        2896
      ]
    },
    {
      "parameters": {
        "url": "=https://n8n.automatizacionesmorf.com/webhook/historial-v3-snapshot?phone={{ $json.phone }}",
        "options": {}
      },
      "id": "4fc770f4-dadf-4168-b5c7-13576576e5ae",
      "name": "Pre-check Version",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        4976,
        2656
      ]
    },
    {
      "parameters": {
        "jsCode": "  // Comparar VERSION para detectar interrupciÃ³n del cliente\n  const preCheckSnapshot = $json;\n  const loopData = $node[\"Loop Over Items\"].json;\n\n  const versionInicial = loopData.version_inicial || \"0\";\n  const versionActual = preCheckSnapshot.version || \"0\";\n\n  // Si la VERSION CAMBIÃ“, significa que hubo actividad en el historial (nuevo mensaje del cliente o respuestas)\n  // Pero solo nos importa si pending_count > 0 (significa que hay un mensaje NUEVO del cliente sin procesar)\n  const pendingCountActual = preCheckSnapshot.pending_count || 0;\n\n  if (versionActual !== versionInicial && pendingCountActual > 0) {\n    console.log('âš ï¸ INTERRUPTED: Cliente enviÃ³ nuevo mensaje durante cadena');\n    console.log('Version inicial:', versionInicial, 'â†’ Actual:', versionActual);\n    console.log('Pending count actual:', pendingCountActual);\n\n    return {\n      should_continue: false,\n      reason: 'interrupted',\n      version_inicial: versionInicial,\n      version_actual: versionActual,\n      pending_count: pendingCountActual,\n      phone: loopData.phone\n    };\n  } else {\n    console.log('âœ… PRE-CHECK PASSED: No hay interrupciones');\n    console.log('Version inicial:', versionInicial, 'â†’ Actual:', versionActual);\n    console.log('Pending count:', pendingCountActual);\n\n    return {\n      should_continue: true,\n      phone: loopData.phone,\n      session_id: loopData.session_id,\n      mensaje: loopData.mensaje,\n      captured_data: loopData.captured_data,\n      intent: loopData.intent\n    };\n  }"
      },
      "id": "b843ab84-c339-445e-a40f-219484409c39",
      "name": "Compare Versions",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        5184,
        2656
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 1
          },
          "conditions": [
            {
              "id": "2705e2b1-324b-4853-94c6-49363a8f616c",
              "leftValue": "={{ $json.should_continue }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "f4308953-d2ac-47a6-b9ee-b91192149928",
      "name": "Should Send?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        5408,
        2656
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.callbell.eu/v1/messages/send",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer kHMm1U4zCkpyYunbFr4eyzzArLs7k9DG.567dec89ec63000252a4ab2a60c3198591f5f780a721c65a82281dd99e4a627a"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({\n    to: $json.phone,\n    from: \"whatsapp\",\n    type: \"text\",\n    content: {\n      text: $json.mensaje.texto\n    }\n  }) }}",
        "options": {}
      },
      "id": "c4f84c46-c643-4035-85cd-9b360eee4190",
      "name": "Send to Callbell",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        6128,
        2384
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://n8n.automatizacionesmorf.com/webhook/historial-v3-callbell-webhook",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $json }}",
        "options": {}
      },
      "id": "efc4e311-a636-4601-b2d9-996ab620ef6b",
      "name": "Save Outbound to Historial",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        6880,
        2512
      ]
    },
    {
      "parameters": {
        "jsCode": "  const callbellResponse = $node[\"Save Outbound to Historial\"].json;                                                                                                                                                                          \n  const ackResponse = $json;                                                                                                                                                                                                                  \n  const compareVersions = $node[\"Compare Versions\"].json;                                                                                                                                                                                     \n                                                                                                                                                                                                                                              \n  // Determinar quÃ© nodo se ejecutÃ³ (texto o template)                                                                                                                                                                                        \n  let callbellNode = null;                                                                                                                                                                                                                    \n  let callbellUuid = null;                                                                                                                                                                                                                    \n  let messageType = 'unknown';                                                                                                                                                                                                                \n                                                                                                                                                                                                                                              \n  try {                                                                                                                                                                                                                                       \n    // Intentar acceder al nodo de texto                                                                                                                                                                                                      \n    const textNode = $node[\"Send to Callbell\"];                                                                                                                                                                                               \n    if (textNode && textNode.json && textNode.json.message) {                                                                                                                                                                                 \n      callbellNode = textNode.json;                                                                                                                                                                                                           \n      callbellUuid = callbellNode.message.uuid;                                                                                                                                                                                               \n      messageType = 'texto';                                                                                                                                                                                                                  \n    }                                                                                                                                                                                                                                         \n  } catch (e) {                                                                                                                                                                                                                               \n    // Nodo de texto no ejecutado                                                                                                                                                                                                             \n  }                                                                                                                                                                                                                                           \n                                                                                                                                                                                                                                              \n  try {                                                                                                                                                                                                                                       \n    // Intentar acceder al nodo de template                                                                                                                                                                                                   \n    const templateNode = $node[\"Send Template to Callbell\"];                                                                                                                                                                                  \n    if (templateNode && templateNode.json && templateNode.json.message) {                                                                                                                                                                     \n      callbellNode = templateNode.json;                                                                                                                                                                                                       \n      callbellUuid = callbellNode.message.uuid;                                                                                                                                                                                               \n      messageType = 'template';                                                                                                                                                                                                               \n    }                                                                                                                                                                                                                                         \n  } catch (e) {                                                                                                                                                                                                                               \n    // Nodo de template no ejecutado                                                                                                                                                                                                          \n  }                                                                                                                                                                                                                                           \n                                                                                                                                                                                                                                              \n  console.log('âœ… MESSAGE SENT SUCCESSFULLY');                                                                                                                                                                                                \n  console.log('Phone:', compareVersions.phone);                                                                                                                                                                                               \n  console.log('Message Type:', messageType);                                                                                                                                                                                                  \n                                                                                                                                                                                                                                              \n  if (messageType === 'texto') {                                                                                                                                                                                                              \n    console.log('Message Text:', compareVersions.mensaje.texto);                                                                                                                                                                              \n  } else if (messageType === 'template') {                                                                                                                                                                                                    \n    console.log('Template Name:', compareVersions.mensaje.template_name);                                                                                                                                                                     \n    console.log('Template UUID:', compareVersions.mensaje.template_uuid);                                                                                                                                                                     \n  }                                                                                                                                                                                                                                           \n                                                                                                                                                                                                                                              \n  console.log('Callbell Message UUID:', callbellUuid);                                                                                                                                                                                        \n  console.log('Saved to Historial:', callbellResponse.success);                                                                                                                                                                               \n  console.log('ACK Updated:', ackResponse.success);                                                                                                                                                                                           \n                                                                                                                                                                                                                                              \n  return {                                                                                                                                                                                                                                    \n    success: true,                                                                                                                                                                                                                            \n    phone: compareVersions.phone,                                                                                                                                                                                                             \n    message_sent: true,                                                                                                                                                                                                                       \n    message_type: messageType,                                                                                                                                                                                                                \n    callbell_uuid: callbellUuid                                                                                                                                                                                                               \n  };"
      },
      "id": "8e97443d-86e8-49f8-9593-9a69e0ffa3d4",
      "name": "Log Success",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        7456,
        3088
      ]
    },
    {
      "parameters": {
        "jsCode": "// Log: No pending messages\nconst snapshot = $json;\nconst parseTrigger = $node[\"Parse Trigger\"].json;\n\nconsole.log('â„¹ï¸ NO PENDING MESSAGES');\nconsole.log('Phone:', parseTrigger.phone);\nconsole.log('Pending count:', snapshot.pending_count);\nconsole.log('Reason: Already processed by another instance');\n\nreturn {\n  skipped: true,\n  reason: 'no_pending',\n  phone: parseTrigger.phone\n};"
      },
      "id": "d6db2b90-2584-4aa8-9022-c17442ae7368",
      "name": "Log No Pending",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2896,
        2960
      ]
    },
    {
      "parameters": {
        "jsCode": "  const callbellResponse = $json;\n  const compareVersions = $node[\"Compare Versions\"].json;\n\n  return {\n    uuid: callbellResponse.message.uuid,\n    from: \"573105879824\",\n    to: compareVersions.phone,\n    text: compareVersions.mensaje.texto,\n    status: \"sent\",\n    createdAt: Date.now()\n  };"
      },
      "id": "4b797713-820f-4db3-838c-fa824bf04459",
      "name": "Prepare Outbound Message",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        6560,
        2384
      ]
    },
    {
      "parameters": {
        "jsCode": "const fs = require('fs');\nconst currentData = $json;\nconst intent = currentData.intent || '';\nconst capturedData = currentData.captured_data || {};\nconst intentsVistos = currentData.intents_vistos || [];\nconst templatesSent = currentData.templates_sent || [];\n\nfunction normalizeIntent(intent) {\n  if (!intent) return '';\n  return intent.toLowerCase().trim().replace(/\\s+/g, '_').replace(/\\+/g, '_').replace(/-/g, '_').replace(/[^a-z0-9_]/g, '');\n}\n\nconsole.log('=== SELECT TEMPLATES DEBUG ===');\nconsole.log('Intent recibido:', intent);\nconsole.log('Intents vistos:', intentsVistos);\nconsole.log('Templates ya enviados:', templatesSent.length);\n\nlet mensajesConfig = {};\nlet intentsConfig = {};\ntry {\n  const mensajesRaw = fs.readFileSync('/files/plantillas/mensajes.json', 'utf8');\n  const intentsRaw = fs.readFileSync('/files/plantillas/intents.json', 'utf8');\n  mensajesConfig = JSON.parse(mensajesRaw);\n  intentsConfig = JSON.parse(intentsRaw);\n} catch (error) {\n  console.log('ERROR leyendo archivos de plantillas:', error.message);\n  return {\n    ...currentData,\n    mensajes_a_enviar: [{\n      tipo: 'texto',\n      texto: 'Gracias por tu mensaje. Un asesor se comunicarÃ¡ contigo pronto.',\n      delay_s: 0\n    }]\n  };\n}\n\nconst intentNormalizado = normalizeIntent(intent);\nconst intentsVistosNormalizados = intentsVistos.map(item => {\n  if (typeof item === 'string') {\n    return normalizeIntent(item);\n  } else if (item && item.intent) {\n    return normalizeIntent(item.intent);\n  }\n  return '';\n}).filter(i => i !== '');\n\nconst esPrimeraVez = !intentsVistosNormalizados.includes(intentNormalizado);\n\nconsole.log('Intent normalizado:', intentNormalizado);\nconsole.log('Intents vistos normalizados:', intentsVistosNormalizados);\nconsole.log('Es primera vez:', esPrimeraVez);\n\nlet intentConfig = null;\n\nif (intentsConfig.intents?.[intent]) {\n  intentConfig = intentsConfig.intents[intent];\n}\n\nif (!intentConfig && intentsConfig.intents_combinados?.[intent]) {\n  intentConfig = intentsConfig.intents_combinados[intent];\n}\n\nif (!intentConfig && mensajesConfig.combinaciones_intents?.[intent]) {\n  intentConfig = mensajesConfig.combinaciones_intents[intent];\n}\n\nconsole.log('intentConfig encontrado:', !!intentConfig);\n\nif (!intentConfig || (!intentConfig.respuesta && !intentConfig.primera_vez)) {\n  console.log('FALLBACK: Intent no configurado');\n  return {\n    ...currentData,\n    mensajes_a_enviar: [{\n      tipo: 'texto',\n      texto: 'Gracias por tu mensaje. Â¿En quÃ© puedo ayudarte?',\n      delay_s: 0\n    }]\n  };\n}\n\nlet plantillasKeys;\nif (intentConfig.respuesta) {\n  plantillasKeys = esPrimeraVez\n    ? intentConfig.respuesta.primera_vez\n    : (intentConfig.respuesta.siguientes || intentConfig.respuesta.primera_vez);\n} else {\n  plantillasKeys = esPrimeraVez\n    ? intentConfig.primera_vez\n    : (intentConfig.siguientes || intentConfig.primera_vez);\n}\n\nconsole.log('Plantillas keys (antes de filtrar):', plantillasKeys);\n\nif (!plantillasKeys || plantillasKeys.length === 0) {\n  return {\n    ...currentData,\n    mensajes_a_enviar: [{\n      tipo: 'texto',\n      texto: 'Gracias por tu mensaje. Â¿En quÃ© puedo ayudarte?',\n      delay_s: 0\n    }]\n  };\n}\n\nconst plantillasFiltradas = plantillasKeys.filter(key => {\n  const plantilla = mensajesConfig.plantillas_base?.[key] ||\n                   mensajesConfig.plantillas_callbell?.[key];\n\n  if (!plantilla) return true;\n\n  const textoPlantilla = plantilla.texto || plantilla.texto_alternativo || '';\n  const primeros100 = textoPlantilla.substring(0, 100);\n\n  const yaEnviado = templatesSent.some(sent =>\n    sent.preview.includes(primeros100.substring(0, 50)) ||\n    primeros100.substring(0, 50).includes(sent.preview.substring(0, 50))\n  );\n\n  if (yaEnviado) {\n    console.log('â­ï¸ SKIPPING (ya enviado):', key);\n  }\n\n  return !yaEnviado;\n});\n\nconsole.log('Plantillas despuÃ©s de filtrar:', plantillasFiltradas);\n\nif (plantillasFiltradas.length === 0) {\n  console.log('âš ï¸ Todas las plantillas ya fueron enviadas');\n  return {\n    ...currentData,\n    mensajes_a_enviar: []\n  };\n}\n\nconst mensajes = [];\nfor (const key of plantillasFiltradas) {\n  if (key.startsWith('/plantilla_')) {\n    const plantilla = mensajesConfig.plantillas_callbell?.[key];\n    if (plantilla) {\n      mensajes.push({\n        tipo: 'template',\n        template_name: plantilla.template_name,\n        template_uuid: plantilla.template_uuid,\n        texto_alternativo: plantilla.texto_alternativo,\n        delay_s: plantilla.delay_s || 2\n      });\n    }\n  } else if (key.startsWith('/')) {\n    const plantilla = mensajesConfig.plantillas_base?.[key];\n    if (plantilla) {\n      mensajes.push({\n        tipo: 'texto',\n        texto: plantilla.texto,\n        delay_s: plantilla.delay_s || 2\n      });\n    }\n  }\n}\n\nconsole.log('Total mensajes construidos:', mensajes.length);\n\nif (intent.startsWith('resumen_')) {\n  const pack = capturedData.pack || '1x';\n  const precio = capturedData.precio || 77900;\n  const nombre = capturedData.nombre || 'Cliente';\n  const direccion = capturedData.direccion || '';\n  const barrio = capturedData.barrio || '';\n  const ciudad = capturedData.ciudad || '';\n  const departamento = capturedData.departamento || '';\n  const telefono = capturedData.telefono || '';\n\n  mensajes.forEach(msg => {\n    if (msg.tipo === 'texto') {\n      msg.texto = msg.texto\n        .replace(/\\{\\{nombre\\}\\}/g, nombre)\n        .replace(/\\{\\{pack\\}\\}/g, pack)\n        .replace(/\\{\\{precio\\}\\}/g, precio.toLocaleString('es-CO'))\n        .replace(/\\{\\{direccion\\}\\}/g, direccion)\n        .replace(/\\{\\{barrio\\}\\}/g, barrio)\n        .replace(/\\{\\{ciudad\\}\\}/g, ciudad)\n        .replace(/\\{\\{departamento\\}\\}/g, departamento)\n        .replace(/\\{\\{telefono\\}\\}/g, telefono);\n    }\n  });\n}\n\nif (mensajes.length > 0) {\n  mensajes[0].delay_s = 0;\n}\n\nconsole.log('=== FIN SELECT TEMPLATES ===');\n\nreturn {\n  ...currentData,\n  mensajes_a_enviar: mensajes,\n  captured_data: capturedData\n};"
      },
      "id": "2cc727b8-b562-4627-b735-11cba6356ffd",
      "name": "Select Templates",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3696,
        2656
      ]
    },
    {
      "parameters": {
        "jsCode": "  const mensajes = $json.mensajes_a_enviar || [];\n  const sessionId = $json.session_id;\n  const phone = $json.phone;\n  const capturedData = $json.captured_data || {};\n  const intent = $json.intent;\n  const snapshotVersion = $json.snapshot_version;\n\n  // CAMBIO: Usar VERSION del snapshot inicial en lugar de pending_count\n  const getSnapshotData = $node[\"Get Snapshot\"].json;\n  const versionInicial = getSnapshotData.version || \"0\";\n\n  // Convertir a array de items para procesar en loop\n  const items = mensajes.map((mensaje, idx) => ({\n    mensaje,\n    msg_index: idx,\n    total: mensajes.length,\n    session_id: sessionId,\n    phone,\n    captured_data: capturedData,\n    intent,\n    snapshot_version: snapshotVersion,\n    version_inicial: versionInicial\n  }));\n\n  console.log('Split Messages:', items.length, 'mensajes');\n  console.log('Version inicial:', versionInicial);\n\n  return items;"
      },
      "id": "b443a168-fe7f-4eae-b786-ae225ac2f86e",
      "name": "Split Messages for Loop",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3888,
        2656
      ]
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        4096,
        2656
      ],
      "id": "6a72786b-85dd-4f3d-af27-5778a2917960",
      "name": "Loop Over Items"
    },
    {
      "parameters": {
        "amount": "={{ $json.mensaje.delay_s }}"
      },
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        4432,
        2656
      ],
      "id": "df017346-8318-467e-a2f0-c1ad20bfd0c9",
      "name": "Wait",
      "webhookId": "0a146ee6-6c33-4e25-93c6-71e22a733d55"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 1
          },
          "conditions": [
            {
              "id": "2705e2b1-324b-4853-94c6-49363a8f616c",
              "leftValue": "={{ $json.mensaje.tipo }}",
              "rightValue": "texto",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "68314ebe-7bad-4f49-b1c0-02e76a5f93e7",
      "name": "Text or Template?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        5840,
        2512
      ]
    },
    {
      "parameters": {
        "jsCode": "  const data = $json;\n\n  console.log('âš ï¸ INTERRUPTED: Cliente enviÃ³ nuevo mensaje durante cadena');\n  console.log('Original version:', data.original_version);\n  console.log('Current version:', data.current_version);\n  console.log('Phone:', data.phone);\n  console.log('Abortando envÃ­o de mensajes restantes');\n\n  return {\n    interrupted: true,\n    reason: data.reason,\n    phone: data.phone\n  };"
      },
      "id": "19dd67cb-e79a-4f6f-89ce-298ade3f6bd0",
      "name": "Log Interrupted",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        5632,
        2752
      ]
    },
    {
      "parameters": {
        "jsCode": "  const mensaje = $json.mensaje;\n  const phone = $json.phone;\n\n  const templateImages = {\n    'e356a05a9a1046c9bd1b5a84b467a496': 'https://somniocolombia.com/cdn/shop/files/Diseno_sin_titulo_17_1920x1920.jpg?v=1720712198',\n    '06cf7d5b74c9430493c30f4ae799603a': 'https://static.callbell.eu/uploads/conversation_attachment/url/179486109/WhatsApp_Image_2025-12-30_at_12.59.10_AM.jpeg'\n  };\n\n  const templateUuid = mensaje.template_uuid || 'e356a05a9a1046c9bd1b5a84b467a496';\n  const imageUrl = templateImages[templateUuid] || templateImages['e356a05a9a1046c9bd1b5a84b467a496'];\n\n  return {\n    ...$json,\n    callbell_body: {\n      to: phone,\n      from: 'whatsapp',\n      type: 'image',\n      content: {\n        url: imageUrl\n      },\n      template_uuid: templateUuid,\n      optin_contact: true\n    }\n  };"
      },
      "id": "66e52bdd-ff9e-44dc-aab4-fa514a27ed09",
      "name": "Prepare Template Message",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        6128,
        2624
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.callbell.eu/v1/messages/send",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer kHMm1U4zCkpyYunbFr4eyzzArLs7k9DG.567dec89ec63000252a4ab2a60c3198591f5f780a721c65a82281dd99e4a627a"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify($json.callbell_body) }}",
        "options": {}
      },
      "id": "67d60de6-496f-448d-a63d-0917bd316790",
      "name": "Send Template to Callbell",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [
        6352,
        2624
      ],
      "continueOnFail": true
    },
    {
      "parameters": {
        "jsCode": "  const callbellResponse = $json;\n  const compareVersions = $node[\"Compare Versions\"].json;\n\n  return {\n    uuid: callbellResponse.message.uuid,\n    from: \"573105879824\",\n    to: compareVersions.phone,\n    text: compareVersions.mensaje.texto_alternativo || 'Imagen enviada',\n    status: \"sent\",\n    createdAt: Date.now()\n  };"
      },
      "id": "3238729f-a0b1-48d0-889a-0c56edf34e86",
      "name": "Prepare Outbound Message (Template)",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        6560,
        2624
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "  -- Borrar mensajes de mi sesiÃ³n (TABLA V3)\n  DELETE FROM messages_v3\n  WHERE session_id IN (\n    SELECT session_id FROM sessions_v3\n    WHERE REPLACE(REPLACE(phone, '+', ''), ' ', '') = '573137549286'\n       OR REPLACE(REPLACE(phone, '+', ''), ' ', '') = '3137549286'\n  );\n\n  -- Borrar mi sesiÃ³n (TABLA V3)\n  DELETE FROM sessions_v3\n  WHERE REPLACE(REPLACE(phone, '+', ''), ' ', '') = '573137549286'\n     OR REPLACE(REPLACE(phone, '+', ''), ' ', '') = '3137549286';\n\n  -- Verificar resultado\n  SELECT\n    'Historial reiniciado: 3137549286' as resultado,\n    (SELECT COUNT(*) FROM sessions_v3 WHERE phone LIKE '%3137549286%') as sesiones_restantes,\n    (SELECT COUNT(*) FROM messages_v3 WHERE session_id IN (SELECT session_id FROM sessions_v3 WHERE phone LIKE '%3137549286%')) as mensajes_restantes;",
        "options": {}
      },
      "id": "4b679097-a8a6-4597-95df-c62465385dad",
      "name": "TEMP - Limpiar TODAS Sesiones 3137549286",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [
        3312,
        3200
      ],
      "credentials": {
        "postgres": {
          "id": "FcG8T3ax5koPBgSx",
          "name": "Postgres account"
        }
      },
      "notes": "TEMPORAL: Borra TODAS las sesiones que contengan 313 en el telÃ©fono. Ejecutar manualmente y eliminar despuÃ©s."
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 1
          },
          "conditions": [
            {
              "id": "ee30b1fa-c1b2-4417-aee5-adf5c0fbc321",
              "leftValue": "={{ $json.intent }}",
              "rightValue": "compra_confirmada",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "55ec47f2-0aa3-4c77-a559-3561f92b4d92",
      "name": "Is Confirmation?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        3904,
        2352
      ]
    },
    {
      "parameters": {
        "method": "PATCH",
        "url": "=https://api.callbell.eu/v1/contacts/{{ $json.contact_id }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer kHMm1U4zCkpyYunbFr4eyzzArLs7k9DG.567dec89ec63000252a4ab2a60c3198591f5f780a721c65a82281dd99e4a627a"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"tags\": [\"WPP\"]\n}",
        "options": {}
      },
      "id": "4d3c216e-c8ba-4510-a785-77a8f05f2416",
      "name": "HTTP: Add WPP Tag",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [
        4160,
        2016
      ]
    },
    {
      "parameters": {
        "amount": 8
      },
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        3456,
        2656
      ],
      "id": "78e5936c-5e0e-499f-85e4-0221ee764fe2",
      "name": "Wait1",
      "webhookId": "2ff8f5ef-5aa0-4aba-a1ea-40ad58584569"
    }
  ],
  "pinData": {},
  "connections": {
    "Webhook Trigger (from Historial)": {
      "main": [
        [
          {
            "node": "Respond Immediately",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Respond Immediately": {
      "main": [
        [
          {
            "node": "Parse Trigger",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Trigger": {
      "main": [
        [
          {
            "node": "Get Snapshot",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Snapshot": {
      "main": [
        [
          {
            "node": "Check Pending > 0",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Pending > 0": {
      "main": [
        [
          {
            "node": "Check Tags (Bot Bloqueado?)",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Log No Pending",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Tags (Bot Bloqueado?)": {
      "main": [
        [
          {
            "node": "IF: Tags Allow Bot?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF: Tags Allow Bot?": {
      "main": [
        [
          {
            "node": "Extract Intent from State",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Log Bot Disabled",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Pre-check Version": {
      "main": [
        [
          {
            "node": "Compare Versions",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Compare Versions": {
      "main": [
        [
          {
            "node": "Should Send?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Should Send?": {
      "main": [
        [
          {
            "node": "Text or Template?",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Log Interrupted",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send to Callbell": {
      "main": [
        [
          {
            "node": "Prepare Outbound Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Save Outbound to Historial": {
      "main": [
        [
          {
            "node": "Log Success",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Outbound Message": {
      "main": [
        [
          {
            "node": "Save Outbound to Historial",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Split Messages for Loop": {
      "main": [
        [
          {
            "node": "Loop Over Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop Over Items": {
      "main": [
        [],
        [
          {
            "node": "Wait",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait": {
      "main": [
        [
          {
            "node": "Pre-check Version",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Text or Template?": {
      "main": [
        [
          {
            "node": "Send to Callbell",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Prepare Template Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Log Success": {
      "main": [
        [
          {
            "node": "Loop Over Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Template Message": {
      "main": [
        [
          {
            "node": "Send Template to Callbell",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Template to Callbell": {
      "main": [
        [
          {
            "node": "Prepare Outbound Message (Template)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Outbound Message (Template)": {
      "main": [
        [
          {
            "node": "Save Outbound to Historial",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Select Templates": {
      "main": [
        [
          {
            "node": "Split Messages for Loop",
            "type": "main",
            "index": 0
          },
          {
            "node": "Is Confirmation?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Is Confirmation?": {
      "main": [
        [
          {
            "node": "HTTP: Add WPP Tag",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait1": {
      "main": [
        [
          {
            "node": "Select Templates",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract Intent from State": {
      "main": [
        [
          {
            "node": "Select Templates",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1",
    "availableInMCP": false
  },
  "versionId": "7c8cbf7f-4e2b-45ec-b611-4bd27b417c03",
  "meta": {
    "instanceId": "4df0d5bdc3c11c3032ef84d3eeea517f836272ccd7fbc040b607c1bfca545db1"
  },
  "id": "4ibfYKjeqbm2veVK",
  "tags": []
}