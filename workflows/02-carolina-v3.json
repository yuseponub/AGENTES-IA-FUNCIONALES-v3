{
  "name": "Agente Carolina v3",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "carolina-v3-process",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "4cc60b0d-7cbd-427b-ab40-5626971796b8",
      "name": "Webhook Trigger (from Historial)",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        -2416,
        208
      ],
      "webhookId": "carolina-v3-process"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ { \"success\": true, \"message\": \"Processing\" } }}",
        "options": {}
      },
      "id": "9d4a2323-f134-469e-9457-138d3b1a024d",
      "name": "Respond Immediately",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [
        -2208,
        208
      ]
    },
    {
      "parameters": {
        "jsCode": "const phone = $json.body?.phone || $json.phone || '';\n\nif (!phone) {\n  throw new Error('Phone parameter required');\n}\n\nreturn { phone };"
      },
      "id": "a0de2b2a-33ad-4183-987c-fedee94e5b28",
      "name": "Parse Trigger",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1984,
        208
      ]
    },
    {
      "parameters": {
        "url": "=https://n8n.automatizacionesmorf.com/webhook/historial-v3-snapshot?phone={{ $json.phone }}",
        "options": {}
      },
      "id": "2e5b5a11-aae9-4554-be7c-2416be6a0151",
      "name": "Get Snapshot",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -1760,
        208
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 1
          },
          "conditions": [
            {
              "id": "2f29b608-4bbc-4324-8db4-4a40d8f9d3c9",
              "leftValue": "={{ $json.pending_count }}",
              "rightValue": 0,
              "operator": {
                "type": "number",
                "operation": "gt"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "155b1130-cbff-4af4-a36e-b2d23006cf97",
      "name": "Check Pending > 0",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        -1536,
        208
      ]
    },
    {
      "parameters": {
        "jsCode": "// Check if bot is disabled by tags\nconst snapshot = $json;\nconst tags = snapshot.tags || [];\n\nconst blockedTags = ['WPP', 'P/W', 'bot_off', 'RECO'];\nconst hasBlockedTag = tags.some(tag => blockedTags.includes(tag));\n\nconsole.log('ðŸ·ï¸ CHECKING TAGS:', {\n  tags,\n  hasBlockedTag,\n  phone: snapshot.phone\n});\n\nreturn {\n  ...snapshot,\n  has_blocked_tag: hasBlockedTag\n};"
      },
      "id": "check-tags-bloqueados-001",
      "name": "Check Tags (Bot Bloqueado?)",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1440,
        112
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "tag-bloqueado-check",
              "leftValue": "={{ $json.has_blocked_tag }}",
              "rightValue": false,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "if-tags-allow-001",
      "name": "IF: Tags Allow Bot?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        -1328,
        112
      ]
    },
    {
      "parameters": {
        "jsCode": "// Log: Bot disabled by tags\nconst snapshot = $json;\n\nconsole.log('ðŸš« BOT DISABLED BY TAGS:', {\n  phone: snapshot.phone,\n  tags: snapshot.tags,\n  reason: 'Bot bloqueado por tags'\n});\n\nreturn {\n  skipped: true,\n  reason: 'bot_disabled_by_tags',\n  phone: snapshot.phone,\n  tags: snapshot.tags\n};"
      },
      "id": "log-bot-disabled-001",
      "name": "Log Bot Disabled",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1328,
        304
      ]
    },
    {
      "parameters": {
        "jsCode": "// CAROLINA V3 SIMPLIFICADO - Solo detecta INTENT\nconst snapshot = $json;\nconst messages = snapshot.messages || [];\nconst messages = snapshot.messages || [];\n\n// ðŸ”¥ NORMALIZAR MENSAJES DE LANDING PAGE\nconst landingPagePattern = /Hola!\\s*Me\\s*interesa\\s*comprar\\s*un\\s*ELIXIR\\s*DEL\\s*SUE[Ã‘N]O?\\.?/gi;\n\nconst normalizedMessages = messages.map(msg => {\n  if (msg.role === 'user') {\n    const originalContent = msg.content;\n    const normalizedContent = originalContent.replace(landingPagePattern, 'hola');\n\n    if (normalizedContent !== originalContent) {\n      console.log('ðŸ”„ NORMALIZED MESSAGE:', originalContent, 'â†’', normalizedContent);\n    }\n\n    return { ...msg, content: normalizedContent };\n  }\n  return msg;\n});\n\n// Convertir a formato Claude\nconst claudeMessages = normalizedMessages.map(msg => ({\n  role: msg.role === 'assistant' ? 'assistant' : 'user',\n  content: msg.content\n}));\n\n// SYSTEM PROMPT SIMPLIFICADO: SOLO DETECTAR INTENT\nconst systemPrompt = `Eres Carolina, asesora de Somnio.\n\nTu ÃšNICA tarea es detectar el intent (intenciÃ³n) del Ãºltimo mensaje del usuario.\n\nRetorna SOLO JSON:\n{\n  \"intent\": \"string\"\n}\n\n**Intents permitidos:**\n- hola (saludo inicial)\n- precio (pregunta precio/valor/costo)\n- contenido_envase (cuÃ¡ntas cÃ¡psulas/comprimidos tiene)\n- como_se_toma (modo de uso/dosis/instrucciones)\n- modopago (formas de pago/contraentrega/transferencia)\n- envio (envÃ­o/cobertura/dÃ³nde llegan)\n- invima (registro sanitario/certificado)\n- ubicacion (sede fÃ­sica/tienda)\n- contraindicaciones (efectos/precauciones)\n- captura_datos_si_compra (quiero comprar/lo quiero/envÃ­amelo)\n- compra_confirmada (cliente dice sÃ­ a confirmaciÃ³n)\n- no_confirmado (cliente dice no/despuÃ©s a confirmaciÃ³n)\n- no_interesa (no me interesa/no lo quiero)\n- fallback (no match con ninguno)\n\n**Intents combinados** (mismo mensaje):\n- hola+precio\n- hola+como_se_toma\n- hola+envio\n- hola+modopago\n- hola+ubicacion\n\nRetorna SOLO el JSON, sin markdown ni texto adicional.`;\n\nreturn {\n  system: systemPrompt,\n  messages: claudeMessages,\n  snapshot_version: snapshot.version,\n  session_id: snapshot.session_id,\n  phone: snapshot.phone,\n  contact_id: snapshot.contact_id || '',\n  state_from_snapshot: snapshot.state || {}\n};"
      },
      "id": "a0271081-a5fd-49d4-9338-e895d399a0d8",
      "name": "Prepare Claude Messages",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1120,
        16
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.anthropic.com/v1/messages",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "anthropicApi",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "anthropic-version",
              "value": "2023-06-01"
            },
            {
              "name": "content-type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ {\n    \"model\": \"claude-sonnet-4-20250514\",\n    \"max_tokens\": 2048,\n    \"temperature\": 0.7,\n    \"system\": $json.system,\n    \"messages\": $json.messages\n  } }}",
        "options": {}
      },
      "id": "be814a1e-8095-4231-a4af-481607e75bef",
      "name": "Process with Claude",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -1104,
        112
      ],
      "credentials": {
        "anthropicApi": {
          "id": "a60NiYpV50szsxWN",
          "name": "Anthropic account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// CAROLINA V3 SIMPLIFICADO - Solo extrae INTENT\nconst claudeResponse = $json;\nconst responseText = claudeResponse.content?.[0]?.text || '{\"intent\":\"fallback\"}';\n\n// Limpiar markdown\nlet cleanText = responseText.trim();\nif (cleanText.startsWith('```json')) {\n  cleanText = cleanText.replace(/^```json\\s*/, '').replace(/\\s*```$/, '');\n} else if (cleanText.startsWith('```')) {\n  cleanText = cleanText.replace(/^```\\s*/, '').replace(/\\s*```$/, '');\n}\n\n// Parsear respuesta - SOLO intent\nlet intent = 'fallback';\ntry {\n  const parsed = JSON.parse(cleanText);\n  intent = parsed.intent || 'fallback';\n} catch (e) {\n  console.log('Error parsing Claude response:', e);\n  intent = 'fallback';\n}\n\nconsole.log('ðŸŽ¯ INTENT DETECTED:', intent);\n\nconst prepareClaude = $node[\"Prepare Claude Messages\"].json;\nconst capturedData = prepareClaude.state_from_snapshot || {};\n\n// Pack detectado viene del snapshot\nconst packDetectado = capturedData.pack || null;\n\n// Campos completos - verificar manualmente (State Analyzer lo harÃ¡ despuÃ©s)\nconst requiredFields = ['nombre', 'apellido', 'telefono', 'direccion', 'ciudad', 'departamento'];\nconst camposCompletos = requiredFields.every(field => {\n  const value = capturedData[field];\n  return value && String(value).trim() !== '';\n});\n\n// Tracking de intents vistos\nconst intentsVistos = capturedData._intents_vistos || [];\n\nreturn {\n  intent,\n  pack_detectado: packDetectado,\n  campos_completos: camposCompletos,\n  captured_data: capturedData,\n  intents_vistos: intentsVistos,\n  snapshot_version: prepareClaude.snapshot_version,\n  phone: prepareClaude.phone,\n  session_id: prepareClaude.session_id,\n  contact_id: prepareClaude.contact_id || ''\n};"
      },
      "id": "16e5eeec-c8a8-4a8f-9161-f0322e71a450",
      "name": "Extract Claude Response",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -880,
        112
      ]
    },
    {
      "parameters": {
        "url": "=https://n8n.automatizacionesmorf.com/webhook/historial-v3-snapshot?phone={{ $json.phone }}",
        "options": {}
      },
      "id": "76cddb18-bd99-466d-9f75-a5c1b9fffb45",
      "name": "Pre-check Version",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        848,
        112
      ]
    },
    {
      "parameters": {
        "jsCode": "  // Comparar VERSION para detectar interrupciÃ³n del cliente\n  const preCheckSnapshot = $json;\n  const loopData = $node[\"Loop Over Items\"].json;\n\n  const versionInicial = loopData.version_inicial || \"0\";\n  const versionActual = preCheckSnapshot.version || \"0\";\n\n  // Si la VERSION CAMBIÃ“, significa que hubo actividad en el historial (nuevo mensaje del cliente o respuestas)\n  // Pero solo nos importa si pending_count > 0 (significa que hay un mensaje NUEVO del cliente sin procesar)\n  const pendingCountActual = preCheckSnapshot.pending_count || 0;\n\n  if (versionActual !== versionInicial && pendingCountActual > 0) {\n    console.log('âš ï¸ INTERRUPTED: Cliente enviÃ³ nuevo mensaje durante cadena');\n    console.log('Version inicial:', versionInicial, 'â†’ Actual:', versionActual);\n    console.log('Pending count actual:', pendingCountActual);\n\n    return {\n      should_continue: false,\n      reason: 'interrupted',\n      version_inicial: versionInicial,\n      version_actual: versionActual,\n      pending_count: pendingCountActual,\n      phone: loopData.phone\n    };\n  } else {\n    console.log('âœ… PRE-CHECK PASSED: No hay interrupciones');\n    console.log('Version inicial:', versionInicial, 'â†’ Actual:', versionActual);\n    console.log('Pending count:', pendingCountActual);\n\n    return {\n      should_continue: true,\n      phone: loopData.phone,\n      session_id: loopData.session_id,\n      mensaje: loopData.mensaje,\n      captured_data: loopData.captured_data,\n      intent: loopData.intent\n    };\n  }"
      },
      "id": "6a07d303-923e-4b12-b20f-a759df089cdf",
      "name": "Compare Versions",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1056,
        112
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 1
          },
          "conditions": [
            {
              "id": "2705e2b1-324b-4853-94c6-49363a8f616c",
              "leftValue": "={{ $json.should_continue }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "44ca5d1d-3669-474d-85b0-33be95442b8b",
      "name": "Should Send?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        1280,
        112
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.callbell.eu/v1/messages/send",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer kHMm1U4zCkpyYunbFr4eyzzArLs7k9DG.567dec89ec63000252a4ab2a60c3198591f5f780a721c65a82281dd99e4a627a"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({\n    to: $json.phone,\n    from: \"whatsapp\",\n    type: \"text\",\n    content: {\n      text: $json.mensaje.texto\n    }\n  }) }}",
        "options": {}
      },
      "id": "39e405db-3a99-4ff9-b4da-39eedd40d268",
      "name": "Send to Callbell",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        2000,
        -160
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://n8n.automatizacionesmorf.com/webhook/historial-v3-callbell-webhook",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $json }}",
        "options": {}
      },
      "id": "e192a329-58ea-438b-b0fa-532f27d2afc6",
      "name": "Save Outbound to Historial",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        2752,
        -32
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://n8n.automatizacionesmorf.com/webhook/historial-v3-ack",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ {\n  \"phone\": $node[\"Compare Versions\"].json.phone,\n  \"expected_version\": $node[\"Loop Over Items\"].json.snapshot_version,\n  \"updates\": {\n    \"last_processed_at\": new Date().toISOString()\n  }\n} }}",
        "options": {}
      },
      "id": "fe87d593-53d8-4f40-a608-a323e98bd5e0",
      "name": "ACK: Update State",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        2848,
        -176
      ]
    },
    {
      "parameters": {
        "jsCode": "  const callbellResponse = $node[\"Save Outbound to Historial\"].json;\n  const ackResponse = $json;\n  const compareVersions = $node[\"Compare Versions\"].json;\n\n  console.log('âœ… MESSAGE SENT SUCCESSFULLY');\n  console.log('Phone:', compareVersions.phone);\n  console.log('Message:', compareVersions.mensaje.texto);\n  console.log('Callbell UUID:', $node[\"Send to Callbell\"].json.message?.uuid);\n  console.log('Saved to Historial:', callbellResponse.success);\n  console.log('ACK Updated:', ackResponse.success);\n\n  return {\n    success: true,\n    phone: compareVersions.phone,\n    message_sent: true\n  };"
      },
      "id": "37c879fb-79b1-4e48-830c-afeaac6d75db",
      "name": "Log Success",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3328,
        544
      ]
    },
    {
      "parameters": {
        "jsCode": "// Log: No pending messages\nconst snapshot = $json;\nconst parseTrigger = $node[\"Parse Trigger\"].json;\n\nconsole.log('â„¹ï¸ NO PENDING MESSAGES');\nconsole.log('Phone:', parseTrigger.phone);\nconsole.log('Pending count:', snapshot.pending_count);\nconsole.log('Reason: Already processed by another instance');\n\nreturn {\n  skipped: true,\n  reason: 'no_pending',\n  phone: parseTrigger.phone\n};"
      },
      "id": "a24cd3eb-f9ba-4d68-89ee-c6e3a7812bc0",
      "name": "Log No Pending",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1328,
        304
      ]
    },
    {
      "parameters": {
        "jsCode": "  const callbellResponse = $json;\n  const compareVersions = $node[\"Compare Versions\"].json;\n\n  return {\n    uuid: callbellResponse.message.uuid,\n    from: \"573105879824\",\n    to: compareVersions.phone,\n    text: compareVersions.mensaje.texto,\n    status: \"sent\",\n    createdAt: Date.now()\n  };"
      },
      "id": "35ae1fb3-6c52-4bbd-9360-bbd90f911705",
      "name": "Prepare Outbound Message",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2432,
        -160
      ]
    },
    {
      "parameters": {
        "jsCode": "  const fs = require('fs');\n  const currentData = $json;\n  const intent = currentData.intent || '';\n  const capturedData = currentData.captured_data || {};\n  const intentsVistos = currentData.intents_vistos || [];\n\n  console.log('=== SELECT TEMPLATES DEBUG ===');\n  console.log('Intent recibido:', intent);\n\n  // Leer plantillas\n  let mensajesConfig = {};\n  let intentsConfig = {};\n  try {\n    const mensajesRaw = fs.readFileSync('/files/plantillas/mensajes.json', 'utf8');\n    const intentsRaw = fs.readFileSync('/files/plantillas/intents.json', 'utf8');\n\n    mensajesConfig = JSON.parse(mensajesRaw);\n    intentsConfig = JSON.parse(intentsRaw);\n  } catch (error) {\n    console.log('ERROR leyendo archivos de plantillas:', error.message);\n    // Fallback si no puede leer archivos\n    return {\n      ...currentData,\n      mensajes_a_enviar: [{\n        tipo: 'texto',\n        texto: 'Gracias por tu mensaje. Un asesor se comunicarÃ¡ contigo pronto.',\n        delay_s: 0\n      }]\n    };\n  }\n\n  // Determinar si es primera vez que ve este intent\n  const esPrimeraVez = !intentsVistos.includes(intent);\n\n  console.log('Intents vistos:', intentsVistos);\n  console.log('Es primera vez:', esPrimeraVez);\n\n  // Buscar configuraciÃ³n del intent\n  let intentConfig = null;\n\n  // 1. Buscar en intentsConfig.intents\n  if (intentsConfig.intents?.[intent]) {\n    intentConfig = intentsConfig.intents[intent];\n  }\n\n  // 2. Buscar en intentsConfig.intents_combinados\n  if (!intentConfig && intentsConfig.intents_combinados?.[intent]) {\n    intentConfig = intentsConfig.intents_combinados[intent];\n  }\n\n  // 3. Buscar en mensajesConfig.combinaciones_intents\n  if (!intentConfig && mensajesConfig.combinaciones_intents?.[intent]) {\n    intentConfig = mensajesConfig.combinaciones_intents[intent];\n  }\n\n  console.log('intentConfig encontrado:', !!intentConfig);\n\n  // Si no hay configuraciÃ³n, fallback\n  if (!intentConfig || (!intentConfig.respuesta && !intentConfig.primera_vez)) {\n    console.log('FALLBACK: Intent no configurado');\n    return {\n      ...currentData,\n      mensajes_a_enviar: [{\n        tipo: 'texto',\n        texto: 'Gracias por tu mensaje. Â¿En quÃ© puedo ayudarte?',\n        delay_s: 0\n      }]\n    };\n  }\n\n  // Obtener plantillas keys\n  let plantillasKeys;\n  if (intentConfig.respuesta) {\n    plantillasKeys = esPrimeraVez\n      ? intentConfig.respuesta.primera_vez\n      : (intentConfig.respuesta.siguientes || intentConfig.respuesta.primera_vez);\n  } else {\n    plantillasKeys = esPrimeraVez\n      ? intentConfig.primera_vez\n      : (intentConfig.siguientes || intentConfig.primera_vez);\n  }\n\n  console.log('Plantillas keys:', plantillasKeys);\n\n  if (!plantillasKeys || plantillasKeys.length === 0) {\n    return {\n      ...currentData,\n      mensajes_a_enviar: [{\n        tipo: 'texto',\n        texto: 'Gracias por tu mensaje. Â¿En quÃ© puedo ayudarte?',\n        delay_s: 0\n      }]\n    };\n  }\n\n  // Construir mensajes\n  const mensajes = [];\n  for (const key of plantillasKeys) {\n    if (key.startsWith('/plantilla_')) {\n      // Plantilla Callbell (con imagen)\n      const plantilla = mensajesConfig.plantillas_callbell?.[key];\n      if (plantilla) {\n        mensajes.push({\n          tipo: 'template',\n          template_name: plantilla.template_name,\n          template_uuid: plantilla.template_uuid,\n          texto_alternativo: plantilla.texto_alternativo,\n          delay_s: plantilla.delay_s || 2\n        });\n      }\n    } else if (key.startsWith('/')) {\n      // Plantilla base (texto simple)\n      const plantilla = mensajesConfig.plantillas_base?.[key];\n      if (plantilla) {\n        mensajes.push({\n          tipo: 'texto',\n          texto: plantilla.texto,\n          delay_s: plantilla.delay_s || 2\n        });\n      }\n    }\n  }\n\n  console.log('Total mensajes construidos:', mensajes.length);\n\n  // Si es resumen (resumen_1x, resumen_2x, resumen_3x), reemplazar variables\n  if (intent.startsWith('resumen_')) {\n    const pack = capturedData.pack || '1x';\n    const precio = capturedData.precio || 77900;\n    const nombre = capturedData.nombre || 'Cliente';\n    const direccion = capturedData.direccion || '';\n    const barrio = capturedData.barrio || '';\n    const ciudad = capturedData.ciudad || '';\n    const departamento = capturedData.departamento || '';\n    const telefono = capturedData.telefono || '';\n\n    mensajes.forEach(msg => {\n      if (msg.tipo === 'texto') {\n        msg.texto = msg.texto\n          .replace(/\\{\\{nombre\\}\\}/g, nombre)\n          .replace(/\\{\\{pack\\}\\}/g, pack)\n          .replace(/\\{\\{precio\\}\\}/g, precio.toLocaleString('es-CO'))\n          .replace(/\\{\\{direccion\\}\\}/g, direccion)\n          .replace(/\\{\\{barrio\\}\\}/g, barrio)\n          .replace(/\\{\\{ciudad\\}\\}/g, ciudad)\n          .replace(/\\{\\{departamento\\}\\}/g, departamento)\n          .replace(/\\{\\{telefono\\}\\}/g, telefono);\n      }\n    });\n  }\n\n  // Actualizar intents_vistos\n  if (!intentsVistos.includes(intent)) {\n    intentsVistos.push(intent);\n    capturedData._intents_vistos = intentsVistos;\n  }\n\n  // NUEVO: Forzar delay 0 en el PRIMER mensaje para respuesta inmediata\n  if (mensajes.length > 0) {\n    mensajes[0].delay_s = 0;\n    console.log('âœ… Primer mensaje configurado con delay 0 (respuesta inmediata)');\n  }\n\n  console.log('=== FIN SELECT TEMPLATES ===');\n\n  return {\n    ...currentData,\n    mensajes_a_enviar: mensajes,\n    captured_data: capturedData\n  };"
      },
      "id": "e3353003-79bb-4b30-9472-f67d6179d6d5",
      "name": "Select Templates",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -432,
        112
      ]
    },
    {
      "parameters": {
        "jsCode": "  const mensajes = $json.mensajes_a_enviar || [];\n  const sessionId = $json.session_id;\n  const phone = $json.phone;\n  const capturedData = $json.captured_data || {};\n  const intent = $json.intent;\n  const snapshotVersion = $json.snapshot_version;\n\n  // CAMBIO: Usar VERSION del snapshot inicial en lugar de pending_count\n  const getSnapshotData = $node[\"Get Snapshot\"].json;\n  const versionInicial = getSnapshotData.version || \"0\";\n\n  // Convertir a array de items para procesar en loop\n  const items = mensajes.map((mensaje, idx) => ({\n    mensaje,\n    msg_index: idx,\n    total: mensajes.length,\n    session_id: sessionId,\n    phone,\n    captured_data: capturedData,\n    intent,\n    snapshot_version: snapshotVersion,\n    version_inicial: versionInicial\n  }));\n\n  console.log('Split Messages:', items.length, 'mensajes');\n  console.log('Version inicial:', versionInicial);\n\n  return items;"
      },
      "id": "85b4a09c-7460-4023-a677-da4a6e13ff99",
      "name": "Split Messages for Loop",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -240,
        112
      ]
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        -32,
        112
      ],
      "id": "3bcfb65a-86b7-4756-957d-c37d4a3957af",
      "name": "Loop Over Items"
    },
    {
      "parameters": {
        "amount": "={{ $json.mensaje.delay_s }}"
      },
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        304,
        112
      ],
      "id": "7b7c4be6-dc06-4781-8be0-bbdd1a3d954a",
      "name": "Wait",
      "webhookId": "0a146ee6-6c33-4e25-93c6-71e22a733d55"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 1
          },
          "conditions": [
            {
              "id": "2705e2b1-324b-4853-94c6-49363a8f616c",
              "leftValue": "={{ $json.mensaje.tipo }}",
              "rightValue": "texto",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "e598c80c-af51-4bdf-862a-41d01432eb14",
      "name": "Text or Template?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        1712,
        -32
      ]
    },
    {
      "parameters": {
        "jsCode": "  const data = $json;\n\n  console.log('âš ï¸ INTERRUPTED: Cliente enviÃ³ nuevo mensaje durante cadena');\n  console.log('Original version:', data.original_version);\n  console.log('Current version:', data.current_version);\n  console.log('Phone:', data.phone);\n  console.log('Abortando envÃ­o de mensajes restantes');\n\n  return {\n    interrupted: true,\n    reason: data.reason,\n    phone: data.phone\n  };"
      },
      "id": "f4c48a93-0f96-47bc-98b1-4f5b713eb6cb",
      "name": "Log Interrupted",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1504,
        208
      ]
    },
    {
      "parameters": {
        "jsCode": "  const mensaje = $json.mensaje;\n  const phone = $json.phone;\n\n  const templateImages = {\n    'e356a05a9a1046c9bd1b5a84b467a496': 'https://somniocolombia.com/cdn/shop/files/Diseno_sin_titulo_17_1920x1920.jpg?v=1720712198',\n    '06cf7d5b74c9430493c30f4ae799603a': 'https://static.callbell.eu/uploads/conversation_attachment/url/179486109/WhatsApp_Image_2025-12-30_at_12.59.10_AM.jpeg'\n  };\n\n  const templateUuid = mensaje.template_uuid || 'e356a05a9a1046c9bd1b5a84b467a496';\n  const imageUrl = templateImages[templateUuid] || templateImages['e356a05a9a1046c9bd1b5a84b467a496'];\n\n  return {\n    ...$json,\n    callbell_body: {\n      to: phone,\n      from: 'whatsapp',\n      type: 'image',\n      content: {\n        url: imageUrl\n      },\n      template_uuid: templateUuid,\n      optin_contact: true\n    }\n  };"
      },
      "id": "19ac06de-604a-414b-b66b-3ab16f5156e9",
      "name": "Prepare Template Message",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2000,
        80
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.callbell.eu/v1/messages/send",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer kHMm1U4zCkpyYunbFr4eyzzArLs7k9DG.567dec89ec63000252a4ab2a60c3198591f5f780a721c65a82281dd99e4a627a"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify($json.callbell_body) }}",
        "options": {}
      },
      "id": "209a6333-100c-44e1-96db-b0f14aabc1df",
      "name": "Send Template to Callbell",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [
        2224,
        80
      ],
      "continueOnFail": true
    },
    {
      "parameters": {
        "jsCode": "  const callbellResponse = $json;\n  const compareVersions = $node[\"Compare Versions\"].json;\n\n  return {\n    uuid: callbellResponse.message.uuid,\n    from: \"573105879824\",\n    to: compareVersions.phone,\n    text: compareVersions.mensaje.texto_alternativo || 'Imagen enviada',\n    status: \"sent\",\n    createdAt: Date.now()\n  };"
      },
      "id": "c7ebf91a-37db-43c0-beca-a1fa229f9554",
      "name": "Prepare Outbound Message (Template)",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2432,
        80
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "  -- Borrar mensajes de mi sesiÃ³n (TABLA V3)\n  DELETE FROM messages_v3\n  WHERE session_id IN (\n    SELECT session_id FROM sessions_v3\n    WHERE REPLACE(REPLACE(phone, '+', ''), ' ', '') = '573137549286'\n       OR REPLACE(REPLACE(phone, '+', ''), ' ', '') = '3137549286'\n  );\n\n  -- Borrar mi sesiÃ³n (TABLA V3)\n  DELETE FROM sessions_v3\n  WHERE REPLACE(REPLACE(phone, '+', ''), ' ', '') = '573137549286'\n     OR REPLACE(REPLACE(phone, '+', ''), ' ', '') = '3137549286';\n\n  -- Verificar resultado\n  SELECT\n    'Historial reiniciado: 3137549286' as resultado,\n    (SELECT COUNT(*) FROM sessions_v3 WHERE phone LIKE '%3137549286%') as sesiones_restantes,\n    (SELECT COUNT(*) FROM messages_v3 WHERE session_id IN (SELECT session_id FROM sessions_v3 WHERE phone LIKE '%3137549286%')) as mensajes_restantes;",
        "options": {}
      },
      "id": "18efa6ca-ef89-43e5-8cee-877f0daba23f",
      "name": "TEMP - Limpiar TODAS Sesiones 3137549286",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [
        -816,
        656
      ],
      "credentials": {
        "postgres": {
          "id": "FcG8T3ax5koPBgSx",
          "name": "Postgres account"
        }
      },
      "notes": "TEMPORAL: Borra TODAS las sesiones que contengan 313 en el telÃ©fono. Ejecutar manualmente y eliminar despuÃ©s."
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 1
          },
          "conditions": [
            {
              "id": "ee30b1fa-c1b2-4417-aee5-adf5c0fbc321",
              "leftValue": "={{ $json.intent }}",
              "rightValue": "compra_confirmada",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "fd5b0aea-77f3-41af-a0e4-cfe690e4014b",
      "name": "Is Confirmation?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        -224,
        -192
      ]
    },
    {
      "parameters": {
        "method": "PATCH",
        "url": "=https://api.callbell.eu/v1/contacts/{{ $json.contact_id }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer kHMm1U4zCkpyYunbFr4eyzzArLs7k9DG.567dec89ec63000252a4ab2a60c3198591f5f780a721c65a82281dd99e4a627a"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"tags\": [\"WPP\"]\n}",
        "options": {}
      },
      "id": "5adb5cee-4273-4cc9-af3e-8fef870ad4c9",
      "name": "HTTP: Add WPP Tag",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [
        32,
        -528
      ]
    },
    {
      "parameters": {
        "amount": 6
      },
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        -672,
        112
      ],
      "id": "4c4583f4-148e-4d25-bef6-4751c365a03e",
      "name": "Wait1",
      "webhookId": "2ff8f5ef-5aa0-4aba-a1ea-40ad58584569"
    },
    {
      "parameters": {
        "jsCode": "// Check if we should create an order in Bigin\n// Conditions: pack detected + minimum data complete + order not already created\n\nconst data = $json;\nconst capturedData = data.captured_data || {};\nconst packDetected = data.pack_detectado || capturedData.pack;\n\nconsole.log('ðŸ” CHECKING IF SHOULD CREATE ORDER...');\nconsole.log('Pack detected:', packDetected);\nconsole.log('Order already created:', capturedData.order_created);\n\n// Minimum required fields to create an order\nconst minimumFields = ['nombre', 'apellido', 'telefono', 'direccion', 'ciudad', 'departamento'];\n\n// Check if minimum fields are complete\nconst minimumComplete = minimumFields.every(f =>\n  capturedData[f] && capturedData[f].trim() !== ''\n);\n\nconsole.log('Minimum fields complete:', minimumComplete);\n\n// Check if order was already created\nconst orderAlreadyCreated = capturedData.order_created === true || capturedData.order_created === 'true';\n\n// Determine if should create order\nconst shouldCreateOrder = (\n  packDetected &&              // Pack was detected\n  minimumComplete &&           // Minimum data is complete\n  !orderAlreadyCreated        // Order not already created\n);\n\nconsole.log('Should create order:', shouldCreateOrder);\n\nreturn {\n  ...data,\n  should_create_order: shouldCreateOrder,\n  pack_detected: packDetected,\n  minimum_complete: minimumComplete,\n  order_already_created: orderAlreadyCreated\n};"
      },
      "id": "20a758c4-ff34-4d44-99d2-f0364cc754e7",
      "name": "Check if Should Create Order",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -640,
        112
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "0914ff1a-dada-4b59-902d-f501c37ae2b5",
              "leftValue": "={{ $json.should_create_order }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "59f191cb-72b1-4801-9c54-c55a34ece4f3",
      "name": "IF: Should Create Order?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        -400,
        112
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "http://localhost:5678/webhook/order-manager",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ {\n  \"phone\": $json.phone,\n  \"captured_data\": $json.captured_data,\n  \"source\": \"carolina_v3\"\n} }}",
        "options": {
          "timeout": 30000
        }
      },
      "id": "d944eff7-7076-4ab1-9a37-fe13ce102052",
      "name": "Call Order Manager",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -160,
        -8
      ]
    },
    {
      "parameters": {
        "jsCode": "// Log order creation result\nconst orderResult = $json;\n\nconsole.log('ðŸ“¦ ORDER MANAGER RESULT:');\nconsole.log('Success:', orderResult.success);\nconsole.log('Order created:', orderResult.order_created);\nconsole.log('Order name:', orderResult.order_name);\n\n// Pass through original data from previous nodes\nconst checkNode = $node[\"Check if Should Create Order\"].json;\n\nreturn {\n  ...checkNode,\n  order_manager_result: orderResult,\n  order_creation_attempted: true\n};"
      },
      "id": "a031cc36-3766-44b9-9656-d6cb54863c1c",
      "name": "Log Order Created",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        80,
        -8
      ]
    }
  ],
  "pinData": {},
  "connections": {
    "Webhook Trigger (from Historial)": {
      "main": [
        [
          {
            "node": "Respond Immediately",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Respond Immediately": {
      "main": [
        [
          {
            "node": "Parse Trigger",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Trigger": {
      "main": [
        [
          {
            "node": "Get Snapshot",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Snapshot": {
      "main": [
        [
          {
            "node": "Check Pending > 0",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Pending > 0": {
      "main": [
        [
          {
            "node": "Check Tags (Bot Bloqueado?)",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Log No Pending",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Tags (Bot Bloqueado?)": {
      "main": [
        [
          {
            "node": "IF: Tags Allow Bot?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF: Tags Allow Bot?": {
      "main": [
        [
          {
            "node": "Prepare Claude Messages",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Log Bot Disabled",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Claude Messages": {
      "main": [
        [
          {
            "node": "Process with Claude",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Process with Claude": {
      "main": [
        [
          {
            "node": "Extract Claude Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract Claude Response": {
      "main": [
        [
          {
            "node": "Check if Should Create Order",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Pre-check Version": {
      "main": [
        [
          {
            "node": "Compare Versions",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Compare Versions": {
      "main": [
        [
          {
            "node": "Should Send?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Should Send?": {
      "main": [
        [
          {
            "node": "Text or Template?",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Log Interrupted",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send to Callbell": {
      "main": [
        [
          {
            "node": "Prepare Outbound Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Save Outbound to Historial": {
      "main": [
        [
          {
            "node": "Log Success",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ACK: Update State": {
      "main": [
        []
      ]
    },
    "Prepare Outbound Message": {
      "main": [
        [
          {
            "node": "Save Outbound to Historial",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Split Messages for Loop": {
      "main": [
        [
          {
            "node": "Loop Over Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop Over Items": {
      "main": [
        [],
        [
          {
            "node": "Wait",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait": {
      "main": [
        [
          {
            "node": "Pre-check Version",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Text or Template?": {
      "main": [
        [
          {
            "node": "Send to Callbell",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Prepare Template Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Log Success": {
      "main": [
        [
          {
            "node": "Loop Over Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Template Message": {
      "main": [
        [
          {
            "node": "Send Template to Callbell",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Template to Callbell": {
      "main": [
        [
          {
            "node": "Prepare Outbound Message (Template)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Outbound Message (Template)": {
      "main": [
        [
          {
            "node": "Save Outbound to Historial",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Select Templates": {
      "main": [
        [
          {
            "node": "Split Messages for Loop",
            "type": "main",
            "index": 0
          },
          {
            "node": "Is Confirmation?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Is Confirmation?": {
      "main": [
        [
          {
            "node": "HTTP: Add WPP Tag",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait1": {
      "main": [
        [
          {
            "node": "Select Templates",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check if Should Create Order": {
      "main": [
        [
          {
            "node": "IF: Should Create Order?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF: Should Create Order?": {
      "main": [
        [
          {
            "node": "Call Order Manager",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Wait1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Call Order Manager": {
      "main": [
        [
          {
            "node": "Log Order Created",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Log Order Created": {
      "main": [
        [
          {
            "node": "Wait1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1",
    "availableInMCP": false
  },
  "versionId": "d9d95848-45db-4cef-8ecf-0ef3068c48c1",
  "meta": {
    "instanceId": "4df0d5bdc3c11c3032ef84d3eeea517f836272ccd7fbc040b607c1bfca545db1"
  },
  "id": "ctXzPL5hLAEx50V4",
  "tags": []
}